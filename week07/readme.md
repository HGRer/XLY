# 必做一

### 目标：按自己设计的表结构，插入 100 万订单模拟数据，测试不同方式的插入效率。

### 计划：用上前面学习到的spring-boot, 线程池管理，线程通信等知识。

### 插入方式：

先创建好100万个记录
多线程：5个线程，各自负责插入20万条数据
利用CountDownLatch类进行线程协商
利用线程池来帮忙管理线程

### 数据库表字段说明：

插入表：user
id，自增
name: 随机生成
gender:随机生成,0,1,2
connect_type:随机生成,TYPE_PHONE,TYPE_EMAIL
connect_value:根据connect_type随机产生11位数字，或者name@163.email
address:null
birthday:随机日期
create_time:数据库时间
update_time:null

### 结果：

被标注为过时的方法，是我在开发过程中耗时比较久的方法。在MYsql官网和群里的帮助下，目前利用load data优化到了6秒左右，其中导入文件路径用的绝对路径，附上具体文件"userinfo1.csv"。

后面从mybatis的foreach改为原来的JDBC，在单线程的情况下优化到了16、12秒，截止到交作业为止（12.20 00:39:00），未实现JDBC+多线程的方式，尽量找时间补上。

--------------------------------------------------

# 必做二

先说结果：实现了动态切换数据源1.0版本，无足够时间实现改进版本。

### 计划：1.先完成主从复制；2.再完成读写分离

### 主从复制

3306作为主数据库，3307作为从数据库

1.安装两个实例

-在window系统上操作服务的命令，net stop mysql, net start mysql, sc delete mysql

-mysqld install 和 mysqld --initialize花费了很长时间

-主库创建用户repl, 赋值权限给该用户

2.登录从库

-为从库登录账户（root）配置主库账户(repl)信息，让从库follow主库

-*注意mysql8.0中的验证问题

3.在从库中需要配置主库的数据，原理是bin-log，relay-log

4.验证同步成功



读写分离一：动态切换数据源版本

-解决SpringBoot配置多数据源

-解决mybatis 注入多数据源到mapper，不熟悉，花费了很长时间

-会出现从库读取不到主库刚插入的数据，所以这里在写入数据之后，让主线程sleep一秒，在这时间里等待从库同步主库数据。

-结果是实现了简单版本的读写分离

-----

# 必做三

###  基于5.0.0版本

一开始使用的是shardingsphere-5.0.0版本，在完成配置后完成了读取分离。利用shardingsphere-5.0.0后，在必做二中的“获取数据源，将数据源区分为主从库，绑定到不同的mapper”这一步不需要处理了。

但是在测试过程中发现，虽然读写分离没有问题，但是仍然存在“写完读”不一致的问题。

### 基于5.0.0-alpha版本

实现读写分离，但是仍未实现读写一致的问题。

以下两个图片来源于官方文档。5.0.0版本无alpha版本中的“*同一线程且同一数据库连接内，如有写入操作，以后的读操作均从主库读取，用于保证数据一致性*”的特性。

又因为alpha版本的官方文档中有的地方有出错（与springboot结合使用那部分，官网中给出的artifactId已经不存在了。），有猜测是否因为alpha版本发生了维护改动，使得“同一线程写读同一个库”的特性移除了，而在官方文档中无对应更新。

**当然我个人经验来说是我的代码出问题/少配置之类的，望老师可以解答下**。

![image-20211220172834376](C:\Users\hgggr\AppData\Roaming\Typora\typora-user-images\image-20211220172834376.png)

![image-20211220172810525](C:\Users\hgggr\AppData\Roaming\Typora\typora-user-images\image-20211220172810525.png)
